# Running Tests with Fig

We can run a simplified test process via [docker-machine](https://github.com/docker/machine) and [fig](http://www.fig.sh/) .  Docker machine enables us to stand up a test environment in any paas environment (including virtual box) and fig allows us to orchestrate containers.

## Pre-Requisites

1. docker-machine installed 
2. docker running somewhere with at least 4GB of RAM available
3. fig installed

## Test Steps

1 - Update ```KAFKA_ADVERTISED_HOST_NAME``` within ```fig.ml```.  This should be the ip of your docker instance.  You can get this via using docker-machine:

```
docker-machine ip
```

2 - Start the cluster via fig:

```
fig up
```

3 - In a separate shell, run your test via the ```kafkatest.sh``` wrapper script:

```
./kafkatest.sh -iterations=200000 -skip=10000 -topic=topic7
```

## Containers

The fig.yml references two containers:

* ```savaki/zookeeper:latest``` - a standard zookeeper 3.4.6 installation
* ```savaki/kafka:latest``` - a tuned version of Kafka

## Performance Results

### Test Environment

* 3.7 GHz Quad-Core Mac Pro 
* OS X 10.10.2
* Virtualbox 4.3.20
* Docker 1.5.0
* All tests executed within docker container running within Virtualbox
* No kernel tuning parameters applied
* Default ulimits

### Tuned Kafka 

* ~670% improvement in consumer performance over default settings

```
LOG> 08:11:06.287990 kafkatest.go:131: done publishing in 10.845130344s , 147531.65238674977 msgs/sec
LOG> 08:11:06.332346 kafkatest.go:138: done consuming in 10.889214789s , 146934.37782274972 msgs/sec
LOG> 08:11:06.332751 client.go:101: Closing Client
1520000 samples. Avg 223.660298 ms. Max 1140.294659 ms. Min 6.974737 ms.
  15.0   9.3% 141289: ********************
  34.0  42.0% 496498: **********************************************************************
  53.0  59.5% 266772: **************************************
  72.0  67.7% 123976: ******************
  91.0  71.5%  58566: *********
 110.0  73.2%  25824: ****
 129.0  74.4%  17935: ***
 148.0  75.7%  19043: ***
 167.0  76.9%  18688: ***
 186.0  77.6%  11491: **
 205.0  78.1%   6806: *
 224.0  78.3%   4031: *
 243.0  78.7%   5595: *
 262.0  79.1%   5211: *
 281.0  79.4%   5085: *
 300.0  79.6%   3028: *
 319.0  79.8%   2420: *
 338.0  80.0%   3806: *
 357.0  80.1%   2017: *
 376.0  80.4%   3696: *
 395.0  80.5%   1758: *
 414.0  80.7%   2685: *
 433.0  80.9%   3008: *
 452.0  81.1%   2996: *
 471.0  81.2%   1642: *
 490.0  81.3%   2339: *
 509.0  81.5%   2391: *
 528.0  81.8%   4238: *
 547.0  82.0%   3306: *
 566.0  82.1%   2009: *
 585.0  82.5%   5092: *
 604.0  82.8%   5559: *
 623.0  83.3%   7800: **
 642.0  83.9%   8439: **
 661.0  84.2%   5514: *
 680.0  84.5%   3393: *
 699.0  84.8%   4318: *
 718.0  85.1%   5099: *
 737.0  85.3%   3185: *
 756.0  85.6%   4044: *
 775.0  85.9%   5458: *
 794.0  86.4%   6675: *
 813.0  86.7%   5680: *
 832.0  87.3%   7989: **
 851.0  87.6%   5592: *
 870.0  88.0%   5714: *
 889.0  88.2%   2743: *
 908.0  88.5%   4101: *
 927.0  88.8%   5779: *
 946.0  89.2%   6002: *
 965.0  89.6%   6178: *
 984.0  90.1%   7408: **
1003.0  90.6%   7305: **
1022.0  91.6%  15262: ***
1041.0  93.7%  32256: *****
1060.0  96.2%  38244: ******
1079.0  98.4%  32629: *****
1098.0  99.5%  17337: ***
1117.0  99.9%   4942: *
1136.0 100.0%   2114: *
test ran 12362.383357 ms and published and received 1600000 messages
```

### Original Kafka

```
LOG> 08:09:17.505350 kafkatest.go:131: done publishing in 1.071457518s , 186661.6236669124 msgs/sec
LOG> 08:09:26.922457 kafkatest.go:138: done consuming in 10.488568554s , 19068.378966138946 msgs/sec
LOG> 08:09:26.923456 client.go:101: Closing Client
190000 samples. Avg 5465.218491 ms. Max 9684.815187 ms. Min 1312.591029 ms.
1381.5   2.1%   4041: ****************************************************
1521.5   3.8%   3120: ****************************************
1661.5   5.4%   3120: ****************************************
1801.5   8.3%   5460: **********************************************************************
1941.5  10.3%   3900: **************************************************
2081.5  12.8%   4680: ************************************************************
2221.5  14.4%   3120: ****************************************
2361.5  16.5%   3900: **************************************************
2501.5  18.1%   3120: ****************************************
2641.5  19.8%   3120: ****************************************
2781.5  21.4%   3120: ****************************************
2921.5  23.4%   3799: *************************************************
3061.5  24.7%   2441: ********************************
3201.5  26.3%   3120: ****************************************
3341.5  28.0%   3120: ****************************************
3481.5  29.2%   2340: ******************************
3621.5  30.9%   3120: ****************************************
3761.5  32.1%   2340: ******************************
3901.5  34.0%   3541: **********************************************
4041.5  36.6%   5039: *****************************************************************
4181.5  38.3%   3120: ****************************************
4321.5  40.3%   3900: **************************************************
4461.5  42.4%   3900: **************************************************
4601.5  44.0%   3120: ****************************************
4741.5  45.6%   3120: ****************************************
4881.5  46.9%   2340: ******************************
5021.5  48.5%   3120: ****************************************
5161.5  50.2%   3120: ****************************************
5301.5  51.4%   2340: ******************************
5441.5  53.0%   3120: ****************************************
5581.5  54.3%   2340: ******************************
5721.5  55.5%   2340: ******************************
5861.5  56.7%   2340: ******************************
6001.5  58.0%   2340: ******************************
6141.5  59.2%   2340: ******************************
6281.5  60.8%   3120: ****************************************
6421.5  62.1%   2340: ******************************
6561.5  63.3%   2340: ******************************
6701.5  64.1%   1560: ********************
6841.5  65.3%   2340: ******************************
6981.5  66.6%   2340: ******************************
7121.5  67.8%   2340: ******************************
7261.5  68.6%   1560: ********************
7401.5  69.9%   2340: ******************************
7541.5  71.1%   2340: ******************************
7681.5  71.9%   1560: ********************
7821.5  73.1%   2340: ******************************
7961.5  74.0%   1560: ********************
8101.5  76.2%   4228: *******************************************************
8241.5  78.9%   5132: ******************************************************************
8381.5  80.9%   3900: **************************************************
8521.5  83.4%   4680: ************************************************************
8661.5  85.5%   3900: **************************************************
8801.5  87.5%   3900: **************************************************
8941.5  89.6%   3900: **************************************************
9081.5  92.0%   4680: ************************************************************
9221.5  94.1%   3900: **************************************************
9361.5  96.5%   4680: ************************************************************
9501.5  98.6%   3900: **************************************************
9641.5 100.0%   2659: ***********************************
test ran 10918.165538 ms and published and received 200000 messages
```